# 智能一卡通应用设计

李则言 吕鑫 卫翔宇

------

## 一、实验背景

​	IC卡 (Integrated Circuit Card，集成电路卡)所具有的信息安全、便于携带、标准化等优点，正使其在身份认证、银行、电信、公共交通、车场管理等领域得到越来越多的应用。而MIFARE 卡则是目前世界上使用量最大、技术最成熟、性能最稳定、内存容量最大的一种感应式智能IC卡。其采用射频无线通讯，除了保留接触式IC卡的原有优点外，还具有操作简单快捷、抗干扰能力强、可靠性高、适合一卡多用等优点。基于MIFARE卡强大的可扩展性，我们可以方便地利用它来设计实现安全可靠、功能强大的校园一卡通应用方案。



## 二、问题分析

​	校园一卡通系统的构建大致可以分为三个部分，读取卡片信息的读卡器、负责与用户交互的终端设备和负责存储信息和进行各种查询的网络后台。考虑到校园卡存在丢失等情况，其中的信息存在被破解的可能，出于安全考虑，此系统中网络后台负责存储全部的用户信息。而另一方面，为了方便起见，此系统允许用户将少量的钱转储到在卡片上存储的“小钱包”上，这个小钱包是不需要终端设备联网的。同时，在终端设备临时断网的时候，我们也允许门禁系统放行最近通过过的少量用户。

​	我们从以下五个方面分析这个系统的安全性问题：

### 1.M1卡

​	1.因为有心人可以通过种种渠道得到校园卡，我们需要禁止他们读到卡片上的内容。为此，我们更改M1卡的A密钥与B密钥，不使用默认的0xFFFFFFFFFFFFh密钥，从而使网上流传的一些读写M1卡内容的代码无法直接读到卡内重要信息。

​	2.即便暴力破解了卡片的密钥，也不能给用户造成什么太大的损失：在校园卡中仅保存最后5条消费储值记录，并不直接保存校园卡余额；小钱包只用于澡卡，水卡等小额消费场景，其中的余额一般不会超过几十元。

### 2.桌面终端

​	1.桌面终端本身运行在封装好的硬件设备中，难以在运行时查看内存中的机密信息。如果不法分子想要破解终端程序，必须首先破坏并且盗走一台终端机器，而这已经不仅仅是信息安全的问题了。

​	2.在外存中保存的access log等信息使用AES加密和随机的无意义密钥。

### 3.网络后台

​	1.使用比较成熟的Django REST framework框架来进行后台的搭建，最大程度的避免了后台被攻击的可能。

​	2.各种终端的认证采用token认证，这样不对密码进行明文传输，保证了密码的安全。

​	3.对于不同的终端，拥有不同的权限（具体见系统设计——网络后台）。

### 4.终端与后台的交互

​	1.网络后台采用https协议，这样在与终端的交互中最大程度的保证了网络传输过程中信息的安全性。

### 5.终端与读卡器的交互

​	1.小钱包中的余额信息使用AES加密传输与存储，避免信息被截获后泄露卡内小钱包余额。



## 三、系统设计

​	如问题分析中所说，整个校园一卡通系统分为3个部分，下面会分别讲述每个部分的具体设计

### 1.智能一卡通（M1卡）与读卡器

​	读卡器基于Arduino Uno与RFID芯片(RFID-RC522)设计实现，其中Arduino作为运行读卡程序的主板，其与RFID-RC522芯片的交互主要基于开源库[MFRC522](https://github.com/miguelbalboa/rfid)，Arduino开发板与读卡芯片的接线如下：

| 读卡器接口 |     开发板接口     |
| :---: | :-----------: |
|  SDA  | Digital IO 10 |
|  SCK  | Digital IO 13 |
| MOSI  | Digital IO 11 |
| MISO  | Digital IO 12 |
|  GND  |      GND      |
|  RST  | Digital IO 9  |
| 3.3V  |      3V       |

​	开发板与桌面终端的交互则通过串口通讯完成。具体而言，在开发板通电启动后首先进行一些简单的初始设置，例如启动与PC端的串口通讯、设置读写密钥等。之后则保持对串口的监听，当收到由PC桌面终端传来的满足一定格式的指令后，便依据指令进行写入卡片数据、读取卡片数据并发送至串口、点亮LED灯等操作。具体的通讯指令如下所列：

|                    指令                    | 发出方  |                   指令意义                   |
| :--------------------------------------: | :--: | :--------------------------------------: |
|              ARRIVAL {uid}               | 读卡器  |    有卡片被读卡芯片检测到时，读卡器向串口写入该指令，告知卡片的UID     |
|                  LEAVE                   | 读卡器  |   检测到的卡片离开时，读卡器向串口写入该指令，桌面终端收到后可做后续处理    |
|              ACCESSACCEPTED              | 桌面终端 | 用于门禁系统，当桌面终端判断检测到的卡片可以通过门禁时发送，读卡器收到后点亮绿色LED灯 |
|               ACCESSDENIED               | 桌面终端 | 用于门禁系统，当桌面终端判断检测到的卡片不允许通过门禁时发送，读卡器收到后点亮红色LED灯 |
| APPENDLOG {timestamp: uint32} {+/-: bit(0/1)} {amount: uint32} {location: 32bytes string} | 桌面终端 | 用于充值/消费系统，当桌面终端得到用户的某条充值/消费记录后，将该记录的时间、充值抑或消费、金额、地点等信息发送至读卡器，由读卡器将其以一定的格式记录在M1卡中 |
|                ASKFORLOG                 | 桌面终端 | 用于充值/消费系统，当桌面终端需要获得卡内的消费记录时，将该指令发送至读卡器，读卡器读出卡中保存的记录并将其以LOG *** 的指令格式写入串口 |
| LOG {timestamp: uint32} {+/-: bit(0/1)} {amount: uint32} {location: 32bytes string} | 读卡器  | 读卡器收到ASKFORLOG指令后，将卡内保存的5条消费记录分别以该指令的格式输出到串口供桌面终端使用。指令具体含义同APPENDLOG。 |
|                  CLEAR                   | 桌面终端 | 桌面终端需要清空卡内的消费记录时可发送该指令到读卡器，读卡器会将卡片中保存的所有消费记录删除 |
| SMALLMONEY {answer: uint32} {answer: uint32} {answer: uint32} {answer: uint32} | 桌面终端 | 用于小钱包系统，对小钱包进行充值/消费时，桌面终端将计算后的小钱包余额以AES加密后以该指令传送给读卡器，读卡器将加密得到的数字记录在M1卡中 |
|                SMALLQUERY                | 桌面终端 | 用于小钱包系统，当桌面终端需要获得卡内的小钱包余额时，将该指令发送至读卡器，读卡器读出卡中保存的记录并将其以SMALLANSWER *** 的指令格式写入串口 |
| SMALLANSWER {answer: uint32} {answer: uint32} {answer: uint32} {answer: uint32} | 读卡器  | 读卡器收到SMALLQUERY指令后，将卡内保存的经过AES加密的小钱包余额信息发送至串口。 |

​	充值/消费信息、小钱包余额等数据在M1卡上保存时均被转化为字节流，写入卡的1\~9号扇区中。另外0号扇区用于保存卡片的基本信息，10号扇区保留以备用，共使用了M1卡16个扇区中的11个。M1卡在读写某个扇区的信息前需要对该扇区的A密钥与B密钥进行校验，而对于白卡而言，所有扇区的密钥均在出厂时被设为0xFFFFFFFFFFFF。为了不使卡里保存的数据轻易泄露，我们将使用到的0~10号扇区的密钥改为了随机密钥0x4E5587B813DF，实际使用时，可以发现在网络上流传的一些读写M1卡的代码均只能读到卡片的5个未使用的空扇区信息，这样的情况与我们在基础实验中读写学校澡卡时极为相似，可以说是较好地保证了卡内信息的安全。

​	另外，涉及到金额时，卡内均未直接保存余额数值这一敏感信息。对于卡内余额，仅保存了消费/储值记录，而对于离线的小钱包余额，则仅保存了AES加密后的余额信息，若不知道桌面终端在加密时使用的密钥，便无法从这样的加密信息中获取真实余额。这样可以使敏感的金额计算在桌面终端或服务器端进行，提高安全性。

### 2.桌面终端

桌面终端的作用是连接用户，后台，读卡器三方，以下将从这三方面分别阐述桌面终端的设计：

1. 与用户的交互

   我们通过python3-tk实现了一个GUI，用于和用户的操作。

2. 与网站后台的交互

3. 与读卡器的交互

一般来讲，桌面终端的所有操作都是需要和后台交互的，这些操作的安全性都是有保障的。唯二不需要后台操作的是小钱包消费和临时断网场景下的门禁系统：



### 3.网络后台

​	网络后台采用Django REST framework模块进行搭建，使用API的交互方式，这样具有较高的移植性。桌面终端通过调用相应的API来实现登录账户、获取门禁权限、充钱和消费等功能。

​	在数据组织上，对于用户我们区分了Register（注册中心，下面简称R）、Access（门禁，下面简称A）、Pos（消费，下面简称P）和ATM（消费和充值，下面简称AT）四种用户，每种用户所具有的权限不同。Register可以为一个学生注册新卡、更新卡的有效期和获取学生的基本信息等，Access则是仅能判断一张卡是否有通过的权限，Pos仅能减少卡的金额，ATM既可以为卡充值也能消费。这样的四种用户基本涵盖了校园卡使用的各个场景，完善的权限控制最大程度的保证了安全性。此外后台还有拥有一个超级管理员root（下面简写为rt）拥有全部的权限。

​	下面是后台的各种API

|                   网址                   |        方法        |     权限      |      解释       |
| :------------------------------------: | :--------------: | :---------: | :-----------: |
|      https://127.0.0.1/register/       |       POST       |     rt      |   注册新的终端用户    |
| https://127.0.0.1/card/decrease_money/ |       POST       |   P/AT/rt   |    消费校园卡金额    |
| https://127.0.0.1/card/increase_money/ |       POST       |    AT/rt    |    充值校园卡金额    |
|     https://127.0.0.1/card/access/     |       POST       |    A/rt     |  检查此卡是否有门禁权限  |
|        https://127.0.0.1/users/        |       GET        |     rt      |  获取全部的终端用户列表  |
|        https://127.0.0.1/card/         |       GET        |    R/rt     | 获取全部的已注册校园卡列表 |
|        https://127.0.0.1/card/         |       POST       |    R/rt     |   添加一个新的校园卡   |
|       https://127.0.0.1/card/id        | PUT/PATCH/DELETE |    R/rt     | 修改/删除某个校园卡信息  |
|       https://127.0.0.1/users/id       | PUT/PATCH/DELETE |     rt      |      修改       |
|         https://127.0.0.1/log/         |       GET        |     rt      |   查看后台操作日志    |
|   https://127.0.0.1/api-token-auth/    |       POST       | R/A/P/AT/rt |  用户获取一个token  |
|  https://127.0.0.1/api-token-refresh/  |       POST       | R/A/P/AT/rt |  用户刷新一个token  |
|   http://127.0.0.1/api-token-verify/   |       POST       | R/A/P/AT/rt |  验证token是否正确  |

## 四、系统评测

## 五、分析与讨论



