# 智能一卡通应用设计

李则言 吕鑫 卫翔宇

------

## 一、实验背景

​	IC卡 (Integrated Circuit Card，集成电路卡)所具有的信息安全、便于携带、标准化等优点，正使其在身份认证、银行、电信、公共交通、车场管理等领域得到越来越多的应用。而MIFARE 卡则是目前世界上使用量最大、技术最成熟、性能最稳定、内存容量最大的一种感应式智能IC卡。其采用射频无线通讯，除了保留接触式IC卡的原有优点外，还具有操作简单快捷、抗干扰能力强、可靠性高、适合一卡多用等优点。基于MIFARE卡强大的可扩展性，我们可以方便地利用它来设计实现安全可靠、功能强大的校园一卡通应用方案。

## 二、问题分析

​	校园一卡通系统的构建大致可以分为三个部分，读取卡片信息的读卡器（Arduino）、负责与用户交互的终端设备（桌面端应用）和负责存储信息和进行各种查询的网络后台（Django实现）。为了保证整个系统的安全性运行，我们需要确保一下五个方面的安全。

#### 1.M1卡

​	1.更改M1卡的A密钥与B密钥，不使用默认的0xFFFFFFFFFFFFh密钥，从而使网上流传的读写M1卡内容的代码无法直接读到卡内重要信息。

​	2.在校园卡中仅保存最后5条消费储值记录，并不直接保存校园卡余额。

#### 2.桌面终端

​	1.桌面终端本身运行在封装好的硬件设备中，难以在运行时查看内存中的机密信息。

​	2.在外存中保存的access log等信息使用AES加密和随机的无意义密钥。

#### 3.网络后台

​	1.使用比较成熟的Django REST framework框架来进行后台的搭建，最大程度的避免了后台被攻击的可能。

​	2.各种终端的认证采用token认证，这样不对密码进行明文传输，保证了密码的安全。

​	3.对于不同的终端，拥有不同的权限（具体见系统设计——网络后台）。

#### 4.终端与后台的交互

​	1.网络后台采用https协议，这样在与终端的交互中最大程度的保证了网络传输过程中信息的安全性。

#### 5.终端与M1卡的交互

​	1.小钱包中的余额信息使用AES加密传输与存储。

## 三、系统设计

​	如问题分析中所说，整个校园一卡通系统分为3个部分，下面会分别讲述每个部分的具体设计

#### 1.Arduino读卡器

#### 2.桌面终端

#### 3.网络后台

​	网络后台采用Django REST framework模块进行搭建，使用API的交互方式，这样具有较高的移植性。桌面终端通过调用相应的API来实现登录账户、获取门禁权限、充钱和消费等功能。

​	在数据组织上，对于用户我们区分了Register（注册中心，下面简称R）、Access（门禁，下面简称A）、Pos（消费，下面简称P）和ATM（消费和充值，下面简称AT）四种用户，每种用户所具有的权限不同。Register可以为一个学生注册新卡、更新卡的有效期和获取学生的基本信息等，Access则是仅能判断一张卡是否有通过的权限，Pos仅能减少卡的金额，ATM既可以为卡充值也能消费。这样的四种用户基本涵盖了校园卡使用的各个场景，完善的权限控制最大程度的保证了安全性。此外后台还有拥有一个超级管理员root（下面简写为rt）拥有全部的权限。

​	下面是后台的各种API

|                                        |        方法        |     权限      |      解释       |
| :------------------------------------: | :--------------: | :---------: | :-----------: |
|      https://127.0.0.1/register/       |       POST       |     rt      |   注册新的终端用户    |
| https://127.0.0.1/card/decrease_money/ |       POST       |   P/AT/rt   |    消费校园卡金额    |
| https://127.0.0.1/card/increase_money/ |       POST       |    AT/rt    |    充值校园卡金额    |
|     https://127.0.0.1/card/access/     |       POST       |    A/rt     |  检查此卡是否有门禁权限  |
|        https://127.0.0.1/users/        |       GET        |     rt      |  获取全部的终端用户列表  |
|        https://127.0.0.1/card/         |       GET        |    R/rt     | 获取全部的已注册校园卡列表 |
|        https://127.0.0.1/card/         |       POST       |    R/rt     |   添加一个新的校园卡   |
|       https://127.0.0.1/card/id        | PUT/PATCH/DELETE |    R/rt     | 修改/删除某个校园卡信息  |
|       https://127.0.0.1/users/id       | PUT/PATCH/DELETE |     rt      |      修改       |
|         https://127.0.0.1/log/         |       GET        |     rt      |   查看后台操作日志    |
|   https://127.0.0.1/api-token-auth/    |       POST       | R/A/P/AT/rt |  用户获取一个token  |
|  https://127.0.0.1/api-token-refresh/  |       POST       | R/A/P/AT/rt |  用户刷新一个token  |
|   http://127.0.0.1/api-token-verify/   |       POST       | R/A/P/AT/rt |  验证token是否正确  |

## 四、系统评测

## 五、分析与讨论



